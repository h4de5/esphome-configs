substitutions:
  # lichterkette christbaum
  devicename: "esp32_3"
  upper_devicename: "ESP32 3"

globals:
  - id: current_effect
    type: int
    restore_value: yes
    initial_value: "0"

<<: !include common/esp32-lights.yaml

esphome:
  <<: !include common/base-light-effects-lambdas.yaml
  name: $devicename
  platform: esp32
  board: az-delivery-devkit-v4
  on_boot:
    priority: 800
    then:
      - light.turn_on:
          id: WS2812b
          # effect unten beim turn on handler einstellen!
          brightness: 50%

sensor:
  - !include common/base-sensor-wifi.yaml
  - !include common/base-sensor-uptime.yaml
  - platform: adc
    # pin: A0
    # use an ADC1 pin
    pin: GPIO34
    # kein name, da internal
    id: "set_brightness"
    internal: true
    filters:
      - calibrate_linear:
          - 0.0 -> 0.0
          - 3.3 -> 1.0
      - lambda: |-
          return x;
      - delta: 0.05
    attenuation: auto
    update_interval: 200ms
    on_value:
      then:
        if:
          condition:
            light.is_on: WS2812b
          then:
            # - logger.log:
            #     format: "Stored value set to: %.1f"
            #     args: ["id(set_brightness).state"]
            #     level: INFO
            - light.turn_on:
                id: WS2812b
                brightness: !lambda |-
                  return x;
            # - homeassistant.service:
            #    service: light.turn_on
            #    data:
            #      entity_id: light.esp32_3_licht
            #      brightness: !lambda |-
            #        return (int)x;

binary_sensor:
  - !include common/base-binarysensor-status.yaml
  # light on/off button
  - platform: gpio
    device_class: light
    name: "${devicename} - Button 1"
    id: "button_1"
    pin:
      number: GPIO32
      mode: INPUT_PULLUP
      # inverted: True
    on_press:
      - light.toggle: "WS2812b"

  # light effect switch button
  - platform: gpio
    device_class: light
    name: "${devicename} - Button 2"
    id: "button_2"
    pin:
      number: GPIO25
      mode: INPUT_PULLUP
    on_press:
      - lambda: |-
          auto call = id(WS2812b).turn_on();

          if (id(current_effect) == 0)
            call.set_effect("Random Twinkle");
          else if (id(current_effect) == 1)
            call.set_effect("Random Twinkle 5%");
          else if (id(current_effect) == 2)
            call.set_effect("Random Twinkle 20%");
          else if (id(current_effect) == 3)
            call.set_effect("Random Twinkle 80%");
          else if (id(current_effect) == 4)
            call.set_effect("Scan");
          else if (id(current_effect) == 5)
            call.set_effect("Color Wipe");
          else if (id(current_effect) == 6)
            call.set_effect("Rainbow");
          else if (id(current_effect) == 7)
            call.set_effect("Fireworks");
          else if (id(current_effect) == 8)
            call.set_effect("Christmas");
          else if (id(current_effect) == 9)
            call.set_effect("Color change");
          else if (id(current_effect) == 10)
            call.set_effect("Random shift");
          else if (id(current_effect) == 11)
            call.set_effect("Starry sky");
          else if (id(current_effect) == 12)
            call.set_effect("Candles");
          else if (id(current_effect) == 13)
            call.set_effect("Flicker");
          else {
              call.set_effect("None");
              id(current_effect) = -1;
          }

          id(current_effect) += 1;
          call.perform();

light:
  - platform: fastled_clockless
    name: "$devicename - Licht"
    icon: mdi:led-outline
    chipset: WS2811
    # pin: D1
    # use an U2 TX pin
    pin: GPIO17
    # half of the leds burned out
    num_leds: 64
    # rgb_order: BRG
    # rgb_order: GRB
    rgb_order: RGB
    # disable on_turn on handler because brightness adc will call it often
    # on_turn_on:
    #  - light.turn_on:
    #      id: WS2812b
    # effect: "Random Twinkle 20%"
    #      effect: None
    # effect: "starry sky"
    # effect: "candles"
    # red: 1
    # green: 0.75
    # blue: 0.2
    # effect: "color change"
    id: WS2812b
    <<: !include common/base-light-effects.yaml

status_led:
  pin:
    number: GPIO02
    #inverted: True
    inverted: False
  id: led_blue
